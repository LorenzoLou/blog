<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lorenzolou.github.io","root":"/blog/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="You can click on the Blog Home to browser my blogs and find more interestingcontent. If there are any issues or suggestions, please feel free to reach out to me or simply submit a merge requeston GitH">
<meta property="og:type" content="article">
<meta property="og:title" content="Domain Driven Design Practical Tutorial">
<meta property="og:url" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/index.html">
<meta property="og:site_name" content="Lorenzo&#39;s Playground">
<meta property="og:description" content="You can click on the Blog Home to browser my blogs and find more interestingcontent. If there are any issues or suggestions, please feel free to reach out to me or simply submit a merge requeston GitH">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/Architecture.png">
<meta property="og:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/adaptor.png">
<meta property="og:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/biz.png">
<meta property="og:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/infrastructure.png">
<meta property="og:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/domain.png">
<meta property="og:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/clean-architecture.png">
<meta property="article:published_time" content="2022-05-30T12:53:50.000Z">
<meta property="article:modified_time" content="2022-06-12T02:51:37.000Z">
<meta property="article:author" content="Lorenzo Lou">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lorenzolou.github.io/blog/2022/05/30/DDD/Architecture.png">

<link rel="canonical" href="https://lorenzolou.github.io/blog/2022/05/30/DDD/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Domain Driven Design Practical Tutorial | Lorenzo's Playground</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lorenzo's Playground</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://lorenzolou.github.io/blog/2022/05/30/DDD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Lorenzo Lou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lorenzo's Playground">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Domain Driven Design Practical Tutorial
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-30 20:53:50" itemprop="dateCreated datePublished" datetime="2022-05-30T20:53:50+08:00">2022-05-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-12 10:51:37" itemprop="dateModified" datetime="2022-06-12T10:51:37+08:00">2022-06-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>You can click on the <a href="https://lorenzolou.github.io/blog/">Blog Home</a> to browser my blogs and find more interesting<br>content. If there are any issues or suggestions, please feel free to reach out to me or simply submit a merge request<br>on <a target="_blank" rel="noopener" href="https://github.com/LorenzoLou">GitHub Link</a></p>
<hr>
<h3 id="What’s-DDD"><a href="#What’s-DDD" class="headerlink" title="What’s DDD?"></a>What’s DDD?</h3><p>DDD(Domain Driven Design) is just a concept, an abstract instruction or direction to help us reduce the complexity of<br>our own application. But because it’s a concept, it has already confused so many developers. We need to implement the<br>concept by ourselves without any restrictions, which means you don’t have a tutorial sample to refer at the beginning.<br>Here we try to provide an implement an application architecture by using DDD concept, but before that, what’s<br>application Architecture?</p>
<h3 id="What’s-Application-Architecture"><a href="#What’s-Application-Architecture" class="headerlink" title="What’s Application Architecture"></a>What’s Application Architecture</h3><p>As we mentioned above, DDD is just a concept, but how we start to develop our own business logics by using this concept?<br>It’s a quite open question which actually does not have a fixed question. But from my perspective, I list the<br>requirements of Application Architecture:</p>
<ol>
<li>Application Architecture should cater kinds of team members in different levels by reduce the communication cost,<br>keep them in the same context, and help us to improve the code quality.</li>
<li>isolate our business codes by any dependencies, for instances the storage logics, the out system api dependencies.</li>
<li>every functionality should be independent and easy to test.</li>
</ol>
<p>here I will provide my own practical experience for you. Hopefully it can benefit you and help you generate your own<br>specific DDD implementations.</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><h4 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h4><p>Let’s say we need to design a system to support users to transfer money.</p>
<h4 id="Development-Requirement-Analise"><a href="#Development-Requirement-Analise" class="headerlink" title="Development Requirement Analise"></a>Development Requirement Analise</h4><ul>
<li>we use h2 as the storage tech stack.</li>
<li>we need to think about the exchange rate.</li>
<li>we have some policy to protect our user from scam.</li>
<li>we can transfer money from accountA to accountB</li>
</ul>
<h4 id="implement-by-using-script-like-coding-style"><a href="#implement-by-using-script-like-coding-style" class="headerlink" title="implement by using script like coding style"></a>implement by using script like coding style</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">public class TransferController &#123;</span><br><span class="line"></span><br><span class="line">    private TransferService transferService;</span><br><span class="line"></span><br><span class="line">    public Result&lt;Boolean&gt; transfer(String targetAccountNumber, BigDecimal amount, HttpSession session) &#123;</span><br><span class="line">        Long userId = (Long) session.getAttribute(&quot;userId&quot;);</span><br><span class="line">        return transferService.transfer(userId, targetAccountNumber, amount, &quot;CNY&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class TransferServiceImpl implements TransferService &#123;</span><br><span class="line"></span><br><span class="line">    private static final String TOPIC_AUDIT_LOG = &quot;TOPIC_AUDIT_LOG&quot;;</span><br><span class="line">    private AccountMapper accountDAO;</span><br><span class="line">    private KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    private YahooForexService yahooForex;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Result&lt;Boolean&gt; transfer(Long sourceUserId, String targetAccountNumber, BigDecimal targetAmount, String targetCurrency) &#123;</span><br><span class="line">        // 1. 从数据库读取数据，忽略所有校验逻辑如账号是否存在等</span><br><span class="line">        AccountDO sourceAccountDO = accountDAO.selectByUserId(sourceUserId);</span><br><span class="line">        AccountDO targetAccountDO = accountDAO.selectByAccountNumber(targetAccountNumber);</span><br><span class="line"></span><br><span class="line">        // 2. 业务参数校验</span><br><span class="line">        if (!targetAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            throw new InvalidCurrencyException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 3. 获取外部数据，并且包含一定的业务逻辑</span><br><span class="line">        // exchange rate = 1 source currency = X target currency</span><br><span class="line">        BigDecimal exchangeRate = BigDecimal.ONE;</span><br><span class="line">        if (sourceAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            exchangeRate = yahooForex.getExchangeRate(sourceAccountDO.getCurrency(), targetCurrency);</span><br><span class="line">        &#125;</span><br><span class="line">        BigDecimal sourceAmount = targetAmount.divide(exchangeRate, RoundingMode.DOWN);</span><br><span class="line"></span><br><span class="line">        // 4. 业务参数校验</span><br><span class="line">        if (sourceAccountDO.getAvailable().compareTo(sourceAmount) &lt; 0) &#123;</span><br><span class="line">            throw new InsufficientFundsException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (sourceAccountDO.getDailyLimit().compareTo(sourceAmount) &lt; 0) &#123;</span><br><span class="line">            throw new DailyLimitExceededException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 5. 计算新值，并且更新字段</span><br><span class="line">        BigDecimal newSource = sourceAccountDO.getAvailable().subtract(sourceAmount);</span><br><span class="line">        BigDecimal newTarget = targetAccountDO.getAvailable().add(targetAmount);</span><br><span class="line">        sourceAccountDO.setAvailable(newSource);</span><br><span class="line">        targetAccountDO.setAvailable(newTarget);</span><br><span class="line"></span><br><span class="line">        // 6. 更新到数据库</span><br><span class="line">        accountDAO.update(sourceAccountDO);</span><br><span class="line">        accountDAO.update(targetAccountDO);</span><br><span class="line"></span><br><span class="line">        // 7. 发送审计消息</span><br><span class="line">        String message = sourceUserId + &quot;,&quot; + targetAccountNumber + &quot;,&quot; + targetAmount + &quot;,&quot; + targetCurrency;</span><br><span class="line">        kafkaTemplate.send(TOPIC_AUDIT_LOG, message);</span><br><span class="line"></span><br><span class="line">        return Result.success(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As we can see this epitomise the typical three layer development approach. But actually there are several big downsides<br>about this type of development.</p>
<ul>
<li>Cost of the maintenance of the system is poor. Every time you’re going to change the verification logics or exchange<br>rate logics or something, you have to update this part of code that involves the parameter verification, storage,<br>compute, calling external service, and so on. For example if we wanna sharding the tables, it will be a disaster.</li>
<li>The scalability of this system is bad. If we wanna add a new transfer function which happens between different bank,<br>none of the codes can be reused.</li>
<li>Very difficult to develop the unit test cases. In this assumption, one method contains the dependency of db, external<br>system, and we need to mock each of them if we just wanna add a unit test case focused on our own business logics.</li>
</ul>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why?"></a>Why?</h3><p>Why we encountered these issues? the reason behind it is the typical three layer architecture breaks several design<br>principles:</p>
<ul>
<li>Single Responsibility Principle. Let’s say we need to do a sharding to one table, we need to update all the logics<br>related to the dao, do in the service method. That’s a violation of Single Responsibility Principle.</li>
<li>Dependency Inversion Principle. You can see our service depend on the implements of db and external service. Once we<br>wanna do some updates of the db or external service, we have to go through the business service code.</li>
<li>Open Closed Principle. If we wanna add some other logics, for instance bank need to charge for a transfer fee. we have<br>to modify the service code rather than add code.</li>
</ul>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>The main objective of our architecture is we can conform the Dependency Inversion Principle. All the database<br>implementations, all the api implementations, all the web api will depend on the kernel layer(domain). But how we<br>implement it in our case?</p>
<p><img src="/blog/2022/05/30/DDD/Architecture.png"></p>
<p>As we can see, we can start develop from domain layer, all the business logics will depend on the abstractions rather<br>than the specific impleme ntations. The most basic dependency is no longer the database, it’s Domain Layer. Domain Layer<br>doesn’t have any dependency on other external dependencies. For instance, we don’t need to think about what kind of<br>database we need to use, how to design the interaction ways with other external systems when we start to develop our<br>system. All these services will depend on the abstractions(ACL classes and Repository classes defined in domain layer).</p>
<p>From this perspective, web controller, rpc service, databases, external api provided by other systems are all at the<br>same level, all of them depend on the abstractions defined by domain layer.</p>
<h4 id="Infrastructure-Layer"><a href="#Infrastructure-Layer" class="headerlink" title="Infrastructure Layer"></a>Infrastructure Layer</h4><p>First, Let’s have a look at the Infrastructure Layer. The implementation(AccountRepositoryImpl) will depend on the<br>AccountRepository defined in Domain Layer. So when we develop our domain business logics, there is no need for us to<br>think how we communicate with database. Relatively speaking when we development how to implement the<br>AccountRepositoryImpl, we also just need to focus on how to store the domain object(Account).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class AccountRepositoryImpl implements AccountRepository &#123;</span><br><span class="line">    private final InfrastructureConverter infrastructureConverter;</span><br><span class="line">    private final AccountDao accountDao;</span><br><span class="line">    private final BalanceDao balanceDao;</span><br><span class="line">    private final CustomerDao customerDao;</span><br><span class="line">    private final CurrencySystem currencySystem;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Long store(Account account) &#123;</span><br><span class="line">        AccountDO accountDO = infrastructureConverter.copy(account);</span><br><span class="line">        CustomerDO customerDO = customerDao.save(accountDO.getCustomerDO());</span><br><span class="line">        BalanceDO balanceDO = balanceDao.save(accountDO.getBalanceDO());</span><br><span class="line">        accountDO.setCustomerDO(customerDO);</span><br><span class="line">        accountDO.setBalanceDO(balanceDO);</span><br><span class="line">        return accountDao.save(accountDO).getAccountNumber();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Account load(Long id) &#123;</span><br><span class="line">        Optional&lt;AccountDO&gt; accountDOOptional = accountDao.findById(id);</span><br><span class="line">        if (accountDOOptional.isEmpty()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        AccountDO accountDO = accountDOOptional.get();</span><br><span class="line">        Account account = infrastructureConverter.copy(accountDO);</span><br><span class="line">        Customer customer = infrastructureConverter.copy(accountDO.getCustomerDO());</span><br><span class="line">        Money money = infrastructureConverter.copy(accountDO.getBalanceDO());</span><br><span class="line">        account.setBalance(money);</span><br><span class="line">        account.setCustomer(customer);</span><br><span class="line">        account.setCurrencySystem(currencySystem);</span><br><span class="line">        return account;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Anti-Corruption-Layer"><a href="#Anti-Corruption-Layer" class="headerlink" title="Anti Corruption Layer"></a>Anti Corruption Layer</h4><p>Besides, we also put ACL in this Infrastructure Layer, once again, the only thing we need to do is focusing on the<br>domain logics. So in Anti Corruption Layer, we need to convert the objects from external system to the objects defined<br>in our own system.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MockCurrencySystem implements CurrencySystem &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Money toDollar(Money money) &#123;</span><br><span class="line">        Float convertedAmount;</span><br><span class="line">        switch (money.getCurrencyType()) &#123;</span><br><span class="line">            case RMB: convertedAmount = money.getAmount() * 7.8F; break;</span><br><span class="line">            case USD: convertedAmount = money.getAmount(); break;</span><br><span class="line">            default: throw new RuntimeException(&quot;unrecognised currency&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return new Money(CurrencyType.USD, convertedAmount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Domain-Layer"><a href="#Domain-Layer" class="headerlink" title="Domain Layer"></a>Domain Layer</h4><p>In the domain layer, we abstract all the business logics into the domain object.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@AllArgsConstructor</span><br><span class="line">public class Account &#123;</span><br><span class="line">    @Getter</span><br><span class="line">    @Setter</span><br><span class="line">    private Long accountNumber;</span><br><span class="line"></span><br><span class="line">    @Getter</span><br><span class="line">    @Setter</span><br><span class="line">    private Customer customer;</span><br><span class="line"></span><br><span class="line">    // to simplify this scenario, Let&#x27;s assume that all bank account money is denominated in USD</span><br><span class="line">    @Getter</span><br><span class="line">    @Setter</span><br><span class="line">    private Money balance;</span><br><span class="line"></span><br><span class="line">    @Setter</span><br><span class="line">    private CurrencySystem currencySystem;</span><br><span class="line"></span><br><span class="line">    @SneakyThrows</span><br><span class="line">    public void withDraw(Money money) &#123;</span><br><span class="line">        Money withDrawMoney = currencySystem.toDollar(money);</span><br><span class="line">        if (balance.getAmount() &gt;= withDrawMoney.getAmount()) &#123;</span><br><span class="line">            balance.setAmount(balance.getAmount() - withDrawMoney.getAmount());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new Exception(&quot;no enough money&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void deposit(Money money) &#123;</span><br><span class="line">        Money depositMoney = currencySystem.toDollar(money);</span><br><span class="line">        balance.setAmount(balance.getAmount() + depositMoney.getAmount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In domain service, we abstract all the business logics that not suitable to put in the entity&#x2F;aggregate object. Here we<br>put all the Limit Policies into the domain service. And suppose someday we need to add more limitStrategy, there is no<br>need for us to update the code. All we need to do is adding code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class AccountDomainService &#123;</span><br><span class="line">    private final List&lt;LimitStrategy&gt; limitStrategyList;</span><br><span class="line"></span><br><span class="line">    public void transferMoney(Account source, Account dest, Money money) &#123;</span><br><span class="line">        for (LimitStrategy limitStrategy : limitStrategyList) &#123;</span><br><span class="line">            limitStrategy.allowable(source, dest, money);</span><br><span class="line">        &#125;</span><br><span class="line">        source.withDraw(money);</span><br><span class="line">        dest.deposit(money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Application-Layer"><a href="#Application-Layer" class="headerlink" title="Application Layer"></a>Application Layer</h4><p>In the application layer, we can find that the ApplicationService will only coordinate the domain objects and domain<br>service to implement the business logics. And it’s so clean and easy for us to meet other requirements by<br>re-coordinating the domain objects.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class AccountApplicationService &#123;</span><br><span class="line">    private final AccountDomainService accountDomainService;</span><br><span class="line">    private final AccountRepository accountRepository;</span><br><span class="line">    private final AccountFactory accountFactory;</span><br><span class="line"></span><br><span class="line">    @SneakyThrows</span><br><span class="line">    @Transactional</span><br><span class="line">    public void transferMoney(Long sourceAccountNumber, Long destAccountNumber, Money amount) &#123;</span><br><span class="line">        Account source = accountRepository.load(sourceAccountNumber);</span><br><span class="line">        Account dest = accountRepository.load(destAccountNumber);</span><br><span class="line">        if (source == null || dest == null) &#123;</span><br><span class="line">            log.error(&quot;error account number: source &#123;&#125;, dest: &#123;&#125;, amount &#123;&#125;&quot;,</span><br><span class="line">                    sourceAccountNumber, destAccountNumber, amount);</span><br><span class="line">            throw new Exception(&quot;invalid account number&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        accountDomainService.transferMoney(source, dest, amount);</span><br><span class="line">        accountRepository.store(source);</span><br><span class="line">        accountRepository.store(dest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void createAccount(AccountDTO accountDTO) &#123;</span><br><span class="line">        Account account = accountFactory.newAccount(accountDTO);</span><br><span class="line">        accountRepository.store(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Unit-Test"><a href="#Unit-Test" class="headerlink" title="Unit Test"></a>Unit Test</h4><ul>
<li>test cases in the Domain Layer, are very easy to develop. we just need to mock the external system results.</li>
<li>test cases in the Infrastructure Layer, are also easy for us to develop. we can use test database like h2, and we can<br>also take advantage of JPA test framework to make our test case development easier.</li>
<li>test cases in Biz Layer, can focus on the coordinate work rather than every business approaches. Practically we just<br>mock several cases to make sure that we can cover the application service.</li>
<li>test cases in Adaptor Layer. We can use spring mvc test tools to test the Adaptors.</li>
</ul>
<p>Ideally, each point above we can reach out to 100% coverage.</p>
<h4 id="System-Structure"><a href="#System-Structure" class="headerlink" title="System Structure"></a>System Structure</h4><p>This is the screenshot of our system’s packages.<br><img src="/blog/2022/05/30/DDD/adaptor.png"><br><img src="/blog/2022/05/30/DDD/biz.png"><br><img src="/blog/2022/05/30/DDD/infrastructure.png"><br><img src="/blog/2022/05/30/DDD/domain.png"></p>
<p>And actually we borrowed some good ideas from Clean Architecture, domain layer is located in the right middle of the<br>circal, Coordinate work, application service wraps the domain layer, and provide service to the Adapter Layer(<br>web&#x2F;api&#x2F;rpc). There is a special point, the infrastructure layer will depend on the domain directly.</p>
<p><img src="/blog/2022/05/30/DDD/clean-architecture.png"></p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Let’s say someday we need to add transaction fee when user transfer money to another account. So first thing come up to<br>our mind is we need to modify some code in our domain layer, maybe we need to add some entity, maybe we need to create<br>another dependency on other system, but the most important thing is, we start to think from the domain layer, and then<br>we think about how to implement the abstraction defined by domain layer, how to save the status of domain objects. The<br>way how we develop, is the very proof that why we call it “driven by the domain”.</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2022/05/30/Principle-of-OAuth2-0/" rel="prev" title="Explaination of the principle of Oauth2.0">
      <i class="fa fa-chevron-left"></i> Explaination of the principle of Oauth2.0
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2022/06/19/Zookeeper-Election/" rel="next" title="Zookeeper Election Mechanism Introduction">
      Zookeeper Election Mechanism Introduction <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#What%E2%80%99s-DDD"><span class="nav-number">1.</span> <span class="nav-text">What’s DDD?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What%E2%80%99s-Application-Architecture"><span class="nav-number">2.</span> <span class="nav-text">What’s Application Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example"><span class="nav-number">3.</span> <span class="nav-text">Example</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Scenario"><span class="nav-number">3.1.</span> <span class="nav-text">Scenario</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Development-Requirement-Analise"><span class="nav-number">3.2.</span> <span class="nav-text">Development Requirement Analise</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#implement-by-using-script-like-coding-style"><span class="nav-number">3.3.</span> <span class="nav-text">implement by using script like coding style</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why"><span class="nav-number">4.</span> <span class="nav-text">Why?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution"><span class="nav-number">5.</span> <span class="nav-text">Solution</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Infrastructure-Layer"><span class="nav-number">5.1.</span> <span class="nav-text">Infrastructure Layer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Anti-Corruption-Layer"><span class="nav-number">5.2.</span> <span class="nav-text">Anti Corruption Layer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Domain-Layer"><span class="nav-number">5.3.</span> <span class="nav-text">Domain Layer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Application-Layer"><span class="nav-number">5.4.</span> <span class="nav-text">Application Layer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Unit-Test"><span class="nav-number">5.5.</span> <span class="nav-text">Unit Test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#System-Structure"><span class="nav-number">5.6.</span> <span class="nav-text">System Structure</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">6.</span> <span class="nav-text">Summary</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lorenzo Lou</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lorenzo Lou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/pisces.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '686954989cace0b7e2ec',
      clientSecret: 'd06f0e8553b92cf39b567431dbeaeec90c9f59a8',
      repo        : 'blog',
      owner       : 'LorenzoLou',
      admin       : ['LorenzoLou'],
      id          : '3aad038c78c05500680edd8ee6bd6c81',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
